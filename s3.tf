# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0

resource "random_pet" "this" {
  length = 2
}

resource "aws_s3_bucket" "input_bucket" {
  #checkov:skip=CKV2_AWS_6:All new buckets have Block Public Access by default
  #checkov:skip=CKV_AWS_145:SSE-S3 rather than SSE-KMS is required for the VT scan to be accurate
  #checkov:skip=CKV_AWS_18:Bucket Access Logging not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_21:Object versioning not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_144:Cross-region replication not necessary; could be added later if required by applications
  #checkov:skip=CKV2_AWS_61:Lifecycle configuration not necessary; could be added later if required by applications
  bucket = "input-bucket-${random_pet.this.id}"
}

resource "aws_s3_bucket_policy" "input_bucket" {
  bucket = aws_s3_bucket.input_bucket.id
  policy = templatefile("${path.module}/policies/bucket_policy.tftpl", { bucket_arn = aws_s3_bucket.input_bucket.arn })
}

resource "aws_s3_bucket_notification" "bucket_notification" {
  depends_on = [aws_lambda_permission.input_bucket_trigger]

  bucket = aws_s3_bucket.input_bucket.id
  lambda_function {
    lambda_function_arn = aws_lambda_function.this.arn
    events              = ["s3:ObjectCreated:*"]
  }
}

resource "aws_s3_bucket" "scanned_bucket" {
  #checkov:skip=CKV2_AWS_6:All new buckets have Block Public Access by default
  #checkov:skip=CKV_AWS_145:SSE-S3 rather than SSE-KMS is required for the VT scan to be accurate; SSE-KMS could be added to the scanned bucket if required
  #checkov:skip=CKV_AWS_18:Bucket Access Logging not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_21:Object versioning not necessary; could be added later if required by applications
  #checkov:skip=CKV2_AWS_62:Event notifications not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_144:Cross-region replication not necessary; could be added later if required by applications
  #checkov:skip=CKV2_AWS_61:Lifecycle configuration not necessary; could be added later if required by applications
  bucket = "scanned-objects-${random_pet.this.id}"
}

resource "aws_s3_bucket_policy" "scanned_bucket" {
  bucket = aws_s3_bucket.scanned_bucket.id
  policy = templatefile("${path.module}/policies/bucket_policy.tftpl", { bucket_arn = aws_s3_bucket.scanned_bucket.arn })
}

resource "aws_s3_bucket" "quarantined_bucket" {
  #checkov:skip=CKV2_AWS_6:All new buckets have Block Public Access by default
  #checkov:skip=CKV_AWS_145:SSE-S3 rather than SSE-KMS is required for the VT scan to be accurate; no benefit to KMS encryption of quarantined objects
  #checkov:skip=CKV_AWS_18:Bucket Access Logging not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_21:Object versioning not necessary; could be added later if required by applications
  #checkov:skip=CKV2_AWS_62:Event notifications not necessary; could be added later if required by applications
  #checkov:skip=CKV_AWS_144:Cross-region replication not necessary; could be added later if required by applications
  #checkov:skip=CKV2_AWS_61:Lifecycle configuration not necessary; could be added later if required by applications
  bucket = "quarantined-objects-${random_pet.this.id}"
}

resource "aws_s3_bucket_policy" "quarantined_bucket" {
  bucket = aws_s3_bucket.quarantined_bucket.id
  policy = templatefile("${path.module}/policies/bucket_policy.tftpl", { bucket_arn = aws_s3_bucket.quarantined_bucket.arn })
}

